image: python:3

stages:
  - format
  - test
  - deploy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  POSTGRES_DB: "cxp_test"
  POSTGRES_USER: "cxp"
  POSTGRES_PASSWORD: "token.01"
  DATABASE_URL: "postgresql+psycopg2://cxp:token.01@cxp_db:5432/cxp_test"

  FIREBASE_PROJECT: "conexperto-admin"
  FIREBASE_TOKEN: "1//01oOxnx8H1x1bCgYIARAAGAESNwF-L9IrDYa8EKEGhP55_lSx5MzPI-76952cMi9esR06R45VTkqzwkYhx5x2ydqBArg1UzfqH54"
  FIREBASE_AUTH_EMULATOR_ADMIN_HOST: "emulator_admin:9099"
  FIREBASE_AUTH_EMULATOR_WEB_HOST: "emulator_web:9098"
  FIREBASE_API_KEY_ADMIN: "AIzaSyD4uyFMfi35s6nae3gjZfB_Wd1hMmNF7_w"
  FIREBASE_API_KEY_WEB: "AIzaSyAe2EVtNNEZ8QZ9WKoGkPqFENCsajQeai4"

  TESTING: "True"

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .cache/pip
    - .venv/

services:
  - name: postgres:13-alpine
    alias: cxp_db
  - name: frfernandezdev/firebase-emulators:latest
    alias: emulator_admin

format:
  stage: format
  before_script:
    - pip install black
    - pip install flake8
  script:
    - black --config .black .
    - flake8 .

test:
  stage: test
  needs:
    - format
  only:
    - main
    - develop
    - /^feature-[0-9]\d*(\.[0-9]\d*)*$/
    - /^hotfix-[0-9]\d*(\.[0-9]\d*)*$/
    - /^staging-[0-9]\d*(\.[0-9]\d*)*$/
    - /^release-[0-9]\d*(\.[0-9]\d*)*$/
    - merge_requests
  variables:
    FIREBASE_PROJECT: "conexperto-6b5e7"
    FIREBASE_PORT: "9098"
  services:
    - name: frfernandezdev/firebase-emulators:latest
      alias: emulator_web
  before_script:
    - pip install virtualenv
    - virtualenv .venv
    - source .venv/bin/activate
    - pip install -r requirements.txt
  script:
    - pytest

staging:
  stage: deploy
  needs:
    - test
  only:
    - main
  script:
    - apt-get update -qy
    - apt-get install -y ruby-dev
    - gem install dpl
    - dpl --provider=heroku --app=cxp-server-staging --api_key=$HEROKU_API_KEY

prod:
  stage: deploy
  needs:
    - test
  only:
    - tags
  script:
    - apt-get update -qy
    - apt-get install -y ruby-dev
    - gem install dpl
    - dpl --provider=heroku --app=cxp-server-prod --api_key=$HEROKU_API_KEY
